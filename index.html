<!DOCTYPE html>

<head>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-colors.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;

        }

        h1,h3 {
            text-align:center;
        }

        h2 {
            border-bottom: 1px solid gray;
        }
        .block_visu1 img {
            float:left;
            width: 700px;
        }
        .block_visu1 svg {
            float:right;
        }
        .block_visu1 {
            clear: both;
            clear: both;
            width: 1300px;
            height: 660px;
        }
       
        #block_chart_1, #block_chart_2  {
            height: 590px;
            width: 1600px;
            margin-top: 40px;
        }
        #block_chart_1 svg, #block_chart_2 svg  {
            display: table-cell;
            width:530px;
            height: 590px;

            padding:10px;
        }
        #block_chart_1 svg:first-child , #block_chart_2 svg:first-child {
             float:left
        }
        text.caption {
            font-size: 1.3em;
        }
        g.tick {
            font-size: 1.3em;
        }
    </style>
</head>

<body>
    <h1>Densité de population Occitanie 2014</h1>
    <img src="src/occitanie-color.svg" alt="densité de population occitanie">
    <svg width="860" height="500"></svg>

    <hr />
    <h1>Élections presidentielles</h1>
    <h2>Résultats du 1er tour</h2>
    <div class="block_visu1">
        <img src="src/occitanie-votes1er.svg" alt="densité de population occitanie">

        <svg height=600 width=350 id="legend_1er_tour"></svg>
    </div>
    <h2 style="margin-top:40px">Analyse du second tour</h2>
 
    <!-- bar chart 1er tour élections --> 
    <div id="block_chart_1">
        <svg height=500 width=450 id="chart_age_votes_lepen"></svg>
        <svg height=500 width=450 id="chart_age_votes_macron"></svg>
    </div>
    <div id="block_chart_2">
            <svg height=600 width=850 id="chart_densite_votes_lepen"></svg>
            <svg height=600 width=850 id="chart_densite_votes_macron"></svg>
            <svg id="legend_2" width="860" height="500"></svg>
    </div> 
    <div id="block_chart_3">
        <svg height=500 width=850 id="routes_territoire"></svg>
        <svg height=500 width=850 id="transports_perimetre"></svg>
    </div>
    <script>
    var year = 2014;
    var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");
    var colors_vote = d3.scaleThreshold().domain([10,20,30,40,60,80,90]).range(["#d6d578","#dab94f","#dc9f25","#dc7525","#823a02","#b55200","#d61507"]);

    var legend_1er_tour = d3.select("#legend_1er_tour");
    var candidats_1er = d3.scaleOrdinal()
    .domain(["LE PEN", "MÉLENCHON","MACRON","FILLON","DUPONT-AIGNAN","ASSELINEAU","LASSALLE","HAMON"])
    .range(d3.schemeSet1);

    var legendRectSize = 110 
    var height_Rect = 30
    var legendSpacing = 40

    var legend_draw = legend_1er_tour
          .append("g")
          .selectAll("g")
          .data(candidats_1er.domain())
          .enter()
          .append('g')
          .attr('class', 'legend')
          .attr('transform', function(d, i) {
            var x = 0;
            var y = (i +1) * 50 ;
            if(i == 0){
              y = 50;
            }
            return 'translate(' + x + ',' + y + ')';
          });
          legend_draw.append('rect')
          .attr('width', legendRectSize)
          .attr('height', height_Rect)
          .style('fill', candidats_1er)
          .style('stroke', candidats_1er);
    
    var myText = legend_draw .append('text')
          .attr('x', legendRectSize + 10)
          .attr('y', legendRectSize - 90)
          .text(function(d) { return d; }); 

    //legende densité 1
    var x = d3.scaleLinear()
        .domain([1, 4800])
        .range([1, 800]);

    var colors = d3.scaleThreshold()
        .domain([1, 10, 50, 200, 500, 1000, 2000, 4800])
        .range(d3.schemeOrRd[9]);
    
    var g = svg.append("g")
        .attr("class", "key")
        .attr("transform", "translate(0,40)");
       
    g.selectAll("rect")
        .data(colors.range().map(function(d) {
            d = colors.invertExtent(d);
            if (d[0] == null) d[0] = x.domain()[0];
            if (d[1] == null) d[1] = x.domain()[1];
            return d;
        }))
        .enter().append("rect")
        .attr("height", 8)
        .attr("x", function(d) { return x(d[0]); })
        .attr("width", function(d) { return x(d[1]) - x(d[0]); })
        .attr("fill", function(d) { return colors(d[0]); });

    g.append("text")
        .attr("class", "caption")
        .attr("x", x.range()[0])
        .attr("y", -6)
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("Densité de population occitanie année "+ year + "  (hab/km2)");

    g.call(d3.axisBottom(x)
        .tickSize(13)
        .tickFormat(function(x, i) { return i < 2 ? "" :  x })
        .tickValues(colors.domain()))
    .select(".domain")
    .remove();

    

    d3.csv("src/TDV_hackaviz_2018.csv", function(data){
       data.ageAverage = +data.moyenne_HF_2014;
       return data;
    }, function (error, datacsv){
        if(error) throw error;   

    var color = "#6d243c";

    //votes par moyenne âge communes//

    var data = d3.nest()
                .key(function(d) { return d.moyenne_HF_2014;})
                .rollup(function(d,i){
                    return (d3.sum(d, function(v){ return v.Voix_LePen} ) / d.length);
                })
                .entries(datacsv);
    
    var dataAverage = d3.nest()
                .key(function(d) { return Math.floor(d.key); })
                .rollup(function(d,i) {         
                    return (d3.sum(d, function(v){ return Math.round(v.value)} )/d.length);
                    })
                .entries(data); 
                    
        //bar chart elections 1er tour moyenne age//
        var svg1 = d3.select("#chart_age_votes_lepen"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width1 = +svg.attr("width") - margin.left - margin.right,
        height1 = +svg.attr("height") - margin.top - margin.bottom;


        var gchart_1 = svg1.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var x1,y1 ; 
        x1= d3.scaleLinear().domain([20,85])
                .range([0,450]);
            
        y1 = d3.scaleLinear().rangeRound([500,0]);
            
        y1.domain([0,d3.max(dataAverage, function(data){
                return data.value
            })]);


        gchart_1.append("text")
            .attr("x", 210)
            .attr("y", 570)
            .style("text-anchor", "middle")
            .text("Age");
        gchart_1.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x",0 - (height1 / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Votes %");
        gchart_1.append("g")
            .attr("class", "axis axis--x")
            .attr("transform", "translate(2,"+ 500+" )")
            .call(d3.axisBottom(x1))
            ;
      
        var yAxis = d3.axisLeft()
                .scale(y1);

        gchart_1.append("g")
            .attr("class", "axis axis--y")
            .call(yAxis)
             

        gchart_1.append("text")
        .attr("class", "caption")
        .attr("x", x1.range()[0])
        .attr("y", -6)
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("Votes Le Pen / Moyenne âge par communes");

        gchart_1.selectAll(".bar")
            .data(dataAverage)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(dataAverage) {  return x1(Math.round(dataAverage.key)); })
            .attr("y", function(dataAverage) {  return y1(Math.round(dataAverage.value)); })
            .attr("width", 20)
            .style("fill", function(d, i) { return color; })

            .attr("height", function(dataAverage) { return height - y1(Math.round(dataAverage.value));  });


       
    var data2 = d3.nest()
    .key(function(d) { return d.moyenne_HF_2014;})
    .rollup(function(d,i){
        return (d3.sum(d, function(v){ return v.Voix_Macron} ) / d.length);
    })
    .entries(datacsv);   

    var svg2 = d3.select("#chart_age_votes_macron"),
    margin2 = {top: 20, right: 20, bottom: 30, left: 20},
    width2 = +svg2.attr("width") - margin2.left - margin2.right,
    height2 = +svg2.attr("height") - margin2.top - margin2.bottom;

   var dataAverage2 = d3.nest()
  .key(function(d) { return Math.floor(d.key); })
  .rollup(function(d,i) {         
      return (d3.sum(d, function(v){ return Math.round(v.value)} )/d.length);
    })
  .entries(data2);

    console.log(dataAverage2.length)
    var x2,y2 ; 
    x2= d3.scaleLinear().domain([20,85])
            .range([0,500]);
          
    y2 = d3.scaleLinear().rangeRound([500, 0]);
        
    y2.domain([0,d3.max(dataAverage2, function(data){
            return data.value
        })]);
    var gchart_2 = svg2.append("g")
    .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");
    gchart_2.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(2," + 500+ ")")
        .call(d3.axisBottom(x2));
    
    var yAxis2 = d3.axisLeft()
            .scale(y2);
            
    gchart_2.append("g")
        .attr("class", "axis axis--y")
        .call(yAxis2)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
    gchart_2.append("text")
        .attr("class", "caption")
        .attr("x", x2.range()[0])
        .attr("y", -6)
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("Votes Macron / Moyenne âge par communes");
       

    gchart_2.selectAll(".bar")
        .data(dataAverage2)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(dataAverage2) {  return x2(Math.round(dataAverage2.key)); })
        .attr("y", function(dataAverage2) {  return y2(Math.round(dataAverage2.value)); })
        .attr("width", 20)
        .style("fill", function(dataAverage2) { return color; })

        .attr("height", function(dataAverage2) { return 500 - y2(Math.round(dataAverage2.value));  });
       
       //votes par densité communes //

var data3 = d3.nest()
             .key(function(d) {  var density = Math.floor(d.population_2014 / (d.superficie/100)); return density;})
             .rollup(function(d,i){
                 return (d3.sum(d, function(v){ return v.Voix_LePen} ) / d.length);
             })
             .entries(datacsv);
 
    
         

        var svg3 = d3.select("#chart_densite_votes_lepen"),
        margin = {top: 20, right: 20, bottom: 40, left: 40},

        width3 = +svg3.attr("width") - margin.left - margin.right,
        height3 = +svg3.attr("height") - margin.top - margin.bottom;
             
        var x3= d3.scaleLinear().domain([0,4800])
        .range([ 0, 550]);
          
        var y3 = d3.scaleLinear().rangeRound([height3, 0]);
        
        y3.domain([0,d3.max(data3, function(data){
            return data.value
        })]);

         var gchart_density_1 = svg3.append("g")
        .attr("class", "key")
        .attr("transform", "translate(0,40)");
        
        var xAxis = d3.axisBottom()
        .scale(x3);

        gchart_density_1.append("g")
            .attr("class", "axis axis--x")
            .attr("transform", "translate(30," + height3 + ")")
            .attr("width",1500)
            .call(d3.axisBottom(x3));
        
        var yAxis3 = d3.axisLeft()
                .scale(y3);
        
        gchart_density_1.append("g")
            .attr("class", "axis axis--y")
            .call(yAxis3)
            .attr("transform", "translate(30," + 0 + ")")

            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end");
        
        gchart_density_1.append("text")
        .attr("class", "caption")
        .attr("x", x3.range()[0])
        .attr("y", -30)
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("Votes Le Pen / Densité population");
        

        
        gchart_density_1.selectAll(".circle")
            .data(data3)
            .enter().append("circle")
            .attr("class", "circle-density")
            .attr("cx", function(data3) { return (x3(Math.round(data3.key))+50); })
            .attr("cy", function(data3) {  return y3(Math.round(data3.value)); })
            .attr("r", function(data3){ return (Math.round(data3.value))/4})
            .style("fill-opacity", // set the fill opacity
 function(data3) {
                return (Math.round(data3.value))/300 })
            .style("fill", function(data3,i) { (data3.value); return colors_vote(data3.value); })
            .transition()

        var data4= d3.nest()
             .key(function(d) {  var density = Math.floor(d.population_2014 / (d.superficie/100)); return density;})
             .rollup(function(d,i){
                 return (d3.sum(d, function(v){ return v.Voix_Macron} ) / d.length);
             })
             .entries(datacsv);
 
    
     

        var svg4 = d3.select("#chart_densite_votes_macron"),
        margin = {top: 20, right: 20, bottom: 40, left: 40},
        width4 = +svg4.attr("width") - margin.left - margin.right,
        height4 = +svg4.attr("height") - margin.top - margin.bottom;
    
             
        var x4= d3.scaleLinear()
        .range([ 0, 450]);

        x4.domain([1,5020]);
        var y4= d3.scaleLinear().rangeRound([height4, 0]);
        
        y4.domain([0,d3.max(data4, function(data){
            return data.value
        })]);

         var gchart_density_2 = svg4.append("g")
        .attr("class", "key")
        .attr("transform", "translate(0,40)");
        
        var xAxis = d3.axisBottom()
        .scale(x4);

        gchart_density_2.append("g")
            .attr("class", "axis axis--x")
            .attr("transform", "translate(30," + height4 +")")
            .attr("width",1500)
            .call(d3.axisBottom(x4));
        
        var yAxis4 = d3.axisLeft()
                .scale(y4);
        
        gchart_density_2.append("g")
            .attr("class", "axis axis--y")
            .call(yAxis4)
            .attr("transform", "translate(30,0)")

            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end");
        
        gchart_density_2.append("text")
        .attr("class", "caption")
        .attr("x", x4.range()[0])
        .attr("y", -30)
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("Votes Macron / Densité population");
        

        
        gchart_density_2.selectAll(".circle")
            .data(data4)
            .enter().append("circle")
            .attr("class", "circle-density")
            .attr("cx", function(data4) { if(data4.key > 4000 ) { (x4(Math.floor(data4.key))); } return x4(Math.floor(data4.key))+50; })
            .attr("cy", function(data4) {  return y4(Math.round(data4.value)); })
            .attr("r", function(data4){ return (Math.round(data4.value))/4})
            .style("fill-opacity", // set the fill opacity
 function(data4) {
                return (Math.round(data4.value))/300 })
            .style("fill", function(data4,i) { return colors_vote(data4.value); })
            .transition()

    //legende densité/votes

    var svg5 = d3.select("#legend_2"); 
    var x5 = d3.scaleLinear()
        .domain([1, 90])
        .range([1, 500]);

  
    
    var g_legend2 = svg5.append("g")
        .attr("class", "key")
        .attr("transform", "translate(0,40)");
       
    g_legend2.selectAll("rect")
        .data(colors_vote.range().map(function(d) {
            d = colors_vote.invertExtent(d);
            if (d[0] == null) d[0] = x5.domain()[0];
            if (d[1] == null) d[1] = x5.domain()[1];
            return d;
        }))
        .enter().append("rect")
        .attr("height", 8)
        .attr("x", function(d) { return x5(d[0]); })
        .attr("width", function(d) { return x5(d[1]) - x5(d[0]); })
        .attr("fill", function(d) { return colors_vote(d[0]); });

    g_legend2.append("text")
        .attr("class", "caption")
        .attr("x", x5.range()[0])
        .attr("y", -6)
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("votes par Densité / communes (%) ");
    g_legend2.call(d3.axisBottom(x5)
        .tickSize(13)
        .tickFormat(function(x) { return x })
        .tickValues(colors_vote.domain()))
        .select(".domain")
        .remove();
    })
   </script>
</body>
